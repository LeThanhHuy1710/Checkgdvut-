<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Trang Quáº£n Trá»‹ GDV</title>
  <link rel="stylesheet" href="../assets/css/admin.css" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-auth-compat.js"></script>
</head>
<body>
  <header>
    <h1>Trang Admin - Quáº£n lÃ½ Giao Dá»‹ch ViÃªn</h1>
    <button onclick="logout()" style="float: right; padding: 6px 10px; background: #d9534f; color: white; border: none; border-radius: 4px;">ÄÄƒng xuáº¥t</button>
  </header>

  <main>
    <section class="form-section">
      <h2>â• ThÃªm Giao Dá»‹ch ViÃªn</h2>
      <form id="formAdd">
        <input type="text" id="name" placeholder="TÃªn GDV" required>
        <input type="text" id="avatar" placeholder="Link áº£nh Ä‘áº¡i diá»‡n">
        <input type="text" id="facebook" placeholder="Link Facebook chÃ­nh">
        <input type="text" id="fb_phu" placeholder="Link Facebook phá»¥">
        <input type="text" id="zalo" placeholder="Sá»‘/Zalo">
        <input type="text" id="website" placeholder="Trang web (náº¿u cÃ³)">
        <textarea id="bank" placeholder="TÃ i khoáº£n ngÃ¢n hÃ ng (má»—i dÃ²ng 1 cÃ¡i)"></textarea>
        <input type="text" id="dichvu" placeholder="CÃ¡c dá»‹ch vá»¥ há»— trá»£, cÃ¡ch nhau báº±ng dáº¥u pháº©y">
        <input type="number" id="baohiem" placeholder="Sá»‘ tiá»n báº£o hiá»ƒm (VNÄ)">
        <input type="date" id="ngay" placeholder="NgÃ y tham gia">
        <textarea id="note" placeholder="Ghi chÃº thÃªm"></textarea>
        <button id="btnAdd" type="submit">â• ThÃªm GDV</button>
      </form>
    </section>

    <section id="gdvList">
      <h2>ğŸ“‹ Danh sÃ¡ch Giao Dá»‹ch ViÃªn</h2>
      <div class="list"></div>
    </section>
  </main>

  <script>
    // Kiá»ƒm tra Ä‘Äƒng nháº­p
    if (!sessionStorage.getItem("admin")) {
      window.location.href = "login.html";
    }

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyDR34V4nSclq1kIMgbnSyMgTMeqUlzFOqo",
      authDomain: "checkgdvut-d2bcc.firebaseapp.com",
      projectId: "checkgdvut-d2bcc",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM
    const form = document.querySelector("#formAdd");
    const btnAdd = document.querySelector("#btnAdd");
    const list = document.querySelector("#gdvList .list");

    const inputName = document.querySelector("#name");
    const inputAvatar = document.querySelector("#avatar");
    const inputFacebook = document.querySelector("#facebook");
    const inputFbPhu = document.querySelector("#fb_phu");
    const inputZalo = document.querySelector("#zalo");
    const inputWebsite = document.querySelector("#website");
    const inputBank = document.querySelector("#bank");
    const inputDichVu = document.querySelector("#dichvu");
    const inputTien = document.querySelector("#baohiem");
    const inputNgay = document.querySelector("#ngay");
    const inputNote = document.querySelector("#note");

    let editId = null;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = inputName.value.trim();
      if (!name) return alert("âŒ Vui lÃ²ng nháº­p tÃªn!");

      const data = {
        name,
        avatar: inputAvatar.value.trim(),
        facebook: inputFacebook.value.trim().replace("https://facebook.com/", ""),
        fb_phu: inputFbPhu.value.trim().replace("https://facebook.com/", ""),
        zalo: inputZalo.value.trim(),
        web: inputWebsite.value.trim(),
        bank: inputBank.value.trim().split("\n"),
        dichvu: inputDichVu.value.trim().split(","),
        baohiem: parseInt(inputTien.value.trim()) || 0,
        ngaybaohiem: inputNgay.value,
        note: inputNote.value.trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (!editId) {
        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
      }

      btnAdd.disabled = true;
      btnAdd.textContent = "â³ Äang xá»­ lÃ½...";

      try {
        if (editId) {
          await db.collection("gdv_list").doc(editId).update(data);
          alert("âœ… Cáº­p nháº­t thÃ nh cÃ´ng!");
          editId = null;
        } else {
          await db.collection("gdv_list").add(data);
          alert("âœ… ThÃªm má»›i thÃ nh cÃ´ng!");
        }

        form.reset();
        loadGDVs();
      } catch (err) {
        alert("âŒ Lá»—i: " + err.message);
      } finally {
        btnAdd.disabled = false;
        btnAdd.textContent = "â• ThÃªm GDV";
      }
    });

    function loadGDVs() {
      list.innerHTML = "";
      db.collection("gdv_list").orderBy("createdAt", "desc").get().then((snap) => {
        snap.forEach((doc) => renderGDV(doc.id, doc.data()));
      });
    }

    function renderGDV(id, d) {
      const div = document.createElement("div");
      div.className = "gdv-item";
      div.innerHTML = `
        <strong>${d.name}</strong><br>
        <small>NgÃ y: ${d.ngaybaohiem || "---"}</small><br>
        Báº£o hiá»ƒm: ${d.baohiem?.toLocaleString()} VNÄ<br>
        Facebook: <a href="https://facebook.com/${d.facebook}" target="_blank">Link</a>
        <div class="buttons">
          <button class="edit" data-id="${id}">âœï¸ Sá»­a</button>
          <button class="delete" data-id="${id}">ğŸ—‘ï¸ XoÃ¡</button>
        </div>
      `;
      list.appendChild(div);
    }

    list.addEventListener("click", async (e) => {
      const id = e.target.dataset.id;
      if (e.target.classList.contains("delete")) {
        if (confirm("â—Báº¡n cÃ³ cháº¯c muá»‘n xoÃ¡ GDV nÃ y?")) {
          await db.collection("gdv_list").doc(id).delete();
          alert("ğŸ—‘ï¸ ÄÃ£ xoÃ¡!");
          loadGDVs();
        }
      }

      if (e.target.classList.contains("edit")) {
        const doc = await db.collection("gdv_list").doc(id).get();
        const d = doc.data();
        inputName.value = d.name || "";
        inputAvatar.value = d.avatar || "";
        inputFacebook.value = "https://facebook.com/" + (d.facebook || "");
        inputFbPhu.value = "https://facebook.com/" + (d.fb_phu || "");
        inputZalo.value = d.zalo || "";
        inputWebsite.value = d.web || "";
        inputBank.value = (d.bank || []).join("\n");
        inputDichVu.value = (d.dichvu || []).join(",");
        inputTien.value = d.baohiem || "";
        inputNgay.value = d.ngaybaohiem || "";
        inputNote.value = d.note || "";
        editId = id;
        btnAdd.textContent = "ğŸ’¾ LÆ°u thay Ä‘á»•i";
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    });

    function logout() {
      sessionStorage.removeItem("admin");
      window.location.href = "login.html";
    }

    // Táº£i danh sÃ¡ch
    loadGDVs();
  </script>
</body>
</html>
